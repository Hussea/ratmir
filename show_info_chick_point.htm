<!DOCTYPE html>
<html lang="ar">
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <meta charset="UTF-8">
  <title>Payroll</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    table, th, td { border: 1px solid #888686; border-collapse: collapse; padding: 8px; }
    table { width: 70%; margin-top: 20px; }
    th { background-color: #f0f0f0; }
    #status { margin-top: 10px; font-weight: bold; color: #444; }
    #info_line { margin-top: 15px; }

    #info_line span {
      margin-right: 15px;
    }
     /* Ù†Ø§ÙØ°Ø© QR Code */
  #qrModal {
    display: none;
    position: fixed;
    top:0; left:0;
    width:100%; height:100%;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    z-index: 9999;
  }
  #qrContent {
    background:#fff;
    padding:20px;
    text-align:center;
    border-radius:8px;
    position: relative;
  }
  #qrContent button {
    margin:5px;
    padding:5px 10px;
  }
  </style>
</head>
<body>

<h2>ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… QR-ĞºĞ¾Ğ´Ğ¾Ğ²</h2>

<!-- Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù -->
 
<input type="text" id="serch_id" style="display: none;">
 

<!-- Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… -->
<p id="status"> Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ¼ĞµÑÑÑ† Ğ¸ Ğ³Ğ¾Ğ´ âš ï¸</p>

<!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© -->
<p id="info_line">
  <span><strong>Ğ•ÑÑ‚ÑŒ:</strong><span id="show_shift"></span></span>
  <span><strong>QR-ĞºĞ¾Ğ´Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¾Ğ±Ñ…Ğ¾Ğ´ Ğ² ĞŸÑ€Ğ¾ĞµĞºÑ‚:</strong> <span id="show_projact_name">---</span></span>
</p>

<!-- Ø¬Ø¯ÙˆÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
<table id="data-table" style="display:none;">
  <thead></thead>
  <tbody></tbody>
</table>
<div id="qrModal">
  <div id="qrContent">
    <div id="qrcode"></div>
    <br>
    <button onclick="downloadQRCode()">ÑĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ QR</button>
    <button onclick="hideQRCode()">Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ</button>
  </div>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  document.getElementById("serch_id").value = params.get("id");
  function loadData() {
    const serch_id = document.getElementById('serch_id').value;
    if (!serch_id) {
      document.getElementById('status').textContent = 'Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ¼ĞµÑÑÑ† Ğ¸ Ğ³Ğ¾Ğ´ â—';
      return;
    }

    let apiUrl = `http://127.0.0.1:8001/show_info_chick_point?employee_id_input=${serch_id}`;

    document.getElementById('status').textContent = 'Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ğŸ”„...';
    document.getElementById('data-table').style.display = 'none';
    document.querySelector('#data-table tbody').innerHTML = '';

    fetch(apiUrl)
      .then(res => res.json())
      .then(data => {
        if (!data || data.length === 0) {
          document.getElementById('status').textContent = 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…';
          return;
        }

        const table = document.getElementById("data-table");
        const thead = table.querySelector("thead");
        const tbody = table.querySelector("tbody");

        thead.innerHTML = "";
        tbody.innerHTML = "";

        // Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù„ÙŠ Ø±Ø§Ø­ ØªØ¸Ù‡Ø± Ø¨Ø§Ù„Ø¬Ø¯ÙˆÙ„
        const displayFields = [ "name_point", "Coordinates"];

        // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø¤ÙˆØ³ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        const headerRow = document.createElement("tr");
        for (let key of displayFields) {
          const th = document.createElement("th");
          th.textContent = key;
          headerRow.appendChild(th);
        }
        thead.appendChild(headerRow);

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙÙˆÙ
        for (let row of data) {
          const tr = document.createElement("tr");

          // Ù†Ø¨Ù†ÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¹ Ø§Ù„Ø¨Ø§Ø±Ø§Ù…ÙŠØªØ± id
          const link = `show_qr_code_fro_check_point.html?id=${encodeURIComponent(row.id)}`;

          for (let key of displayFields) {
            const td = document.createElement("td");
            td.innerHTML = `<a href="${link}" style="text-decoration:none; color:inherit;">${row[key] ?? ""}</a>`;
            tr.appendChild(td);
          }

          tbody.appendChild(tr);

          // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¢Ø®Ø± Ù…Ø±Ø©
          document.getElementById('show_projact_name').textContent = row.projuct_title || "---";
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
        document.getElementById('show_shift').textContent = data.length;

        // Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        table.style.display = "table";
        document.getElementById('status').style.display = 'none';
      })
      .catch(err => {
        document.getElementById('status').textContent = 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…';
        console.error(err);
      });
  }

  ///////
   // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù€ QR
  function showQRCode(link) {
    document.getElementById('qrModal').style.display = 'flex';
    document.getElementById('qrcode').innerHTML = "";
    new QRCode(document.getElementById('qrcode'), {
      text: link,
      width: 200,
      height: 200,
      colorDark: "#000000",
      colorLight: "#ffffff"
    });
  }

  function hideQRCode() {
    document.getElementById('qrModal').style.display = 'none';
  }

  function downloadQRCode() {
    const qrImg = document.querySelector('#qrcode img');
    if (qrImg) {
      const link = document.createElement('a');
      link.href = qrImg.src;
      link.download = 'qrcode.png';
      link.click();
    }
  }

  // ØªØ¹Ø¯ÙŠÙ„ loadData Ù„ØªÙØ¹ÙŠÙ„ QR Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø·
  function loadData() {
    const serch_id = document.getElementById('serch_id').value;
    if (!serch_id) {
      document.getElementById('status').textContent = 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… â—';
      return;
    }

    let apiUrl = `http://127.0.0.1:8001/show_info_chick_point?employee_id_input=${serch_id}`;
    document.getElementById('status').textContent = 'Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ğŸ”„...';
    document.getElementById('data-table').style.display = 'none';
    document.querySelector('#data-table tbody').innerHTML = '';

    fetch(apiUrl)
      .then(res => res.json())
      .then(data => {
        if (!data || data.length === 0) {
          document.getElementById('status').textContent = 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…';
          return;
        }

        const table = document.getElementById("data-table");
        const thead = table.querySelector("thead");
        const tbody = table.querySelector("tbody");

        thead.innerHTML = "";
        tbody.innerHTML = "";

        const displayFields = ["name_point", "Coordinates"];

        const headerRow = document.createElement("tr");
        for (let key of displayFields) {
          const th = document.createElement("th");
          th.textContent = key;
          headerRow.appendChild(th);
        }
        thead.appendChild(headerRow);

        for (let row of data) {
          const tr = document.createElement("tr");

          const link = `file:///C:/Users/Acer/Desktop/work/ratmir/show_qr_code_fro_check_point.html?id=${encodeURIComponent(row.id)}`;

          for (let key of displayFields) {
            const td = document.createElement("td");
            td.innerHTML = `<a href="javascript:void(0)" style="text-decoration:none; color:inherit;">${row[key] ?? ""}</a>`;
            td.querySelector('a').onclick = () => showQRCode(link);
            tr.appendChild(td);
          }

          tbody.appendChild(tr);
          document.getElementById('show_projact_name').textContent = row.projuct_title || "---";
        }

        document.getElementById('show_shift').textContent = data.length;
        table.style.display = "table";
        document.getElementById('status').style.display = 'none';
      })
      .catch(err => {
        document.getElementById('status').textContent = 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…';
        console.error(err);
      });
  }
  // âœ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø¯Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
window.onload = loadData;
</script>

</body>
</html>
