<!DOCTYPE html>
<html lang="ar">
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <meta charset="UTF-8">
  <title>Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… QR-ĞºĞ¾Ğ´Ğ¾Ğ²</title>
  {% extends "try.html" %}
  {% block page_css %}
    
  <style>
     /* ===== RESET ===== */
* {
  box-sizing: border-box;
}

html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  overflow-x: hidden;
  font-family: "Poppins", Arial, sans-serif;
  background-color: #f4f6f9;
  color: #2d3436;
}

/* ===== CONTENT CENTER ===== */
center {
  width: 100%;
  padding: 15px;
}

/* ===== HEADINGS ===== */
h2 {
  font-size: 24px;
  margin-bottom: 15px;
  text-align: center;
}

/* ===== STATUS & INFO ===== */
#status {
  font-size: 14px;
  margin: 10px 0;
}

#info_line {
  background: #ffffff;
  padding: 12px;
  border-radius: 10px;
  margin: 10px auto 20px;
  width: 100%;
  max-width: 800px;
  text-align: center;
  line-height: 1.6;
}

#info_line span {
  display: inline-block;
  margin: 5px 10px;
}

/* ===== TABLE (DESKTOP) ===== */
table {
  width: 80%;
  margin: 20px auto;
  border-collapse: collapse;
  background: #ffffff;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 6px 15px rgba(0,0,0,0.08);
}

th {
  background-color: #dfe6e9;
  padding: 12px;
  font-size: 14px;
  text-align: center;
}

td {
  padding: 10px;
  font-size: 13px;
  text-align: center;
  word-break: break-word;
}

table, th, td {
  border: 1px solid #b2bec3;
}

/* ===== LINKS IN TABLE ===== */
td a {
  text-decoration: none;
  color: #0984e3;
  font-weight: 500;
}

td a:hover {
  text-decoration: underline;
}

/* ===== QR MODAL ===== */
#qrModal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(38, 37, 37, 0.7);
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

#qrContent {
  background: #ffffff;
  padding: 20px;
  border-radius: 14px;
  text-align: center;
  width: 90%;
  max-width: 320px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.3);
}

#qrContent button {
  width: 100%;
  margin-top: 10px;
  padding: 10px;
  border: none;
  border-radius: 8px;
  font-size: 14px;
  cursor: pointer;
  background: #0984e3;
  color: white;
}

#qrContent button:last-child {
  background: #636e72;
}

#qrContent button:hover {
  opacity: 0.9;
}

/* ØªÙˆØ³ÙŠØ· QR Code Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø© */
#qrcode {
  display: flex;
  justify-content: center;
  align-items: center;
  margin: 15px auto;
}

/* ================= MOBILE ================= */
@media (max-width: 768px) {

  h2 {
    font-size: 20px;
  }

  /* ğŸ”¥ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¥Ù„Ù‰ Cards */
  table,
  thead,
  tbody,
  tr,
  th,
  td {
    display: block;
    width: 100%;
  }

  thead {
    display: none;
  }

  table {
    background: transparent;
    box-shadow: none;
    width: 100%;
  }

  tr {
    background: #ffffff;
    margin-bottom: 15px;
    padding: 12px;
    border-radius: 14px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  }

  td {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 5px;
    border-bottom: 1px solid #eee;
    font-size: 14px;
    text-align: right;
  }

  td:last-child {
    border-bottom: none;
  }

  td::before {
    content: attr(data-label);
    font-weight: bold;
    color: #636e72;
    margin-left: 10px;
    white-space: nowrap;
  }
}

/* ===== SMALL PHONES ===== */
@media (max-width: 480px) {
  td {
    font-size: 13px;
  }
}

 
</style>
{% endblock %}

<body>
{% block content %}

<center>
<h2>ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… QR-ĞºĞ¾Ğ´Ğ¾Ğ²</h2>

<!-- Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¸Ù -->
 
<input type="text" id="serch_id" style="display: none;">
 

<!-- Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… -->
<p id="status"> Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ¼ĞµÑÑÑ† Ğ¸ Ğ³Ğ¾Ğ´ âš ï¸</p>

<!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© -->
<p id="info_line">
  <span><strong>Ğ•ÑÑ‚ÑŒ:</strong><span id="show_shift"></span></span>
  <span><strong>QR-ĞºĞ¾Ğ´Ğ¾Ğ² Ğ´Ğ»Ñ Ğ¾Ğ±Ñ…Ğ¾Ğ´ Ğ² ĞŸÑ€Ğ¾ĞµĞºÑ‚:</strong> <span id="show_projact_name">---</span></span>
</p>

<!-- Ø¬Ø¯ÙˆÙ„ Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
<table id="data-table" style="display:none;">
  <thead></thead>
  <tbody></tbody>
</table>
<div id="qrModal">
  <div id="qrContent">
    <div id="qrcode"></div>
    <br>
    <button onclick="downloadQRCode()">ÑĞºĞ°Ñ‡Ğ°Ñ‚ÑŒ QR</button>
    <button onclick="hideQRCode()">Ğ·Ğ°ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ</button>
  </div>
</div>
</center>


<script>
  const params = new URLSearchParams(window.location.search);
  document.getElementById("serch_id").value = params.get("id");
  function loadData() {
    const serch_id = document.getElementById('serch_id').value;
    if (!serch_id) {
      document.getElementById('status').textContent = 'Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ Ğ¼ĞµÑÑÑ† Ğ¸ Ğ³Ğ¾Ğ´ â—';
      return;
    }

    let apiUrl = `/api/show_info_chick_point?employee_id_input=${serch_id}`;

    document.getElementById('status').textContent = 'Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ğŸ”„...';
    document.getElementById('data-table').style.display = 'none';
    document.querySelector('#data-table tbody').innerHTML = '';

    fetch(apiUrl)
      .then(res => res.json())
      .then(data => {
        if (!data || data.length === 0) {
          document.getElementById('status').textContent = 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…1';
          return;
        }

        const table = document.getElementById("data-table");
        const thead = table.querySelector("thead");
        const tbody = table.querySelector("tbody");

        thead.innerHTML = "";
        tbody.innerHTML = "";

        // Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù„ÙŠ Ø±Ø§Ø­ ØªØ¸Ù‡Ø± Ø¨Ø§Ù„Ø¬Ø¯ÙˆÙ„
        const displayFields = [ "name_point", "Coordinates"];

        // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø¤ÙˆØ³ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        const headerRow = document.createElement("tr");
        for (let key of displayFields) {
          const th = document.createElement("th");
          th.textContent = key;
          headerRow.appendChild(th);
        }
        thead.appendChild(headerRow);

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙÙˆÙ
        for (let row of data) {
          const tr = document.createElement("tr");

          // Ù†Ø¨Ù†ÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø¹ Ø§Ù„Ø¨Ø§Ø±Ø§Ù…ÙŠØªØ± id
          const link = `/show_qr_code_fro_check_point?id=${encodeURIComponent(row.id)}`;

          for (let key of displayFields) {
            const td = document.createElement("td");
            td.innerHTML = `<a href="${link}" style="text-decoration:none; color:inherit;">${row[key] ?? ""}</a>`;
            tr.appendChild(td);
          }

          tbody.appendChild(tr);

          // ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¢Ø®Ø± Ù…Ø±Ø©
          document.getElementById('show_projact_name').textContent = row.projuct_title || "---";
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
        document.getElementById('show_shift').textContent = data.length;

        // Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        table.style.display = "table";
        document.getElementById('status').style.display = 'none';
      })
      .catch(err => {
        document.getElementById('status').textContent = 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…2';
        console.error(err);
      });
  }

  ///////
   // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù€ QR
  function showQRCode(link) {
    document.getElementById('qrModal').style.display = 'flex';
    document.getElementById('qrcode').innerHTML = "";
    new QRCode(document.getElementById('qrcode'), {
      text: link,
      width: 200,
      height: 200,
      colorDark: "#000000",
      colorLight: "#ffffff"
    });
  }

  function hideQRCode() {
    document.getElementById('qrModal').style.display = 'none';
  }

  function downloadQRCode() {
    const qrImg = document.querySelector('#qrcode img');
    if (qrImg) {
      const link = document.createElement('a');
      link.href = qrImg.src;
      link.download = 'qrcode.png';
      link.click();
    }
  }

  // ØªØ¹Ø¯ÙŠÙ„ loadData Ù„ØªÙØ¹ÙŠÙ„ QR Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø·
  function loadData() {
    const serch_id = document.getElementById('serch_id').value;
    if (!serch_id) {
      document.getElementById('status').textContent = 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…3 â—';
      return;
    }

    let apiUrl = `/api/show_info_chick_point?employee_id_input=${serch_id}`;
    document.getElementById('status').textContent = 'Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… ğŸ”„...';
    document.getElementById('data-table').style.display = 'none';
    document.querySelector('#data-table tbody').innerHTML = '';

    fetch(apiUrl)
      .then(res => res.json())
      .then(data => {
        if (!data || data.length === 0) {
          document.getElementById('status').textContent = 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…4';
          return;
        }

        const table = document.getElementById("data-table");
        const thead = table.querySelector("thead");
        const tbody = table.querySelector("tbody");

        thead.innerHTML = "";
        tbody.innerHTML = "";

        const displayFields = ["name_point", "Coordinates", "id_entry_emp"];

        const headerRow = document.createElement("tr");
        for (let key of displayFields) {
          const th = document.createElement("th");
          th.textContent = key;
          headerRow.appendChild(th);
        }
        thead.appendChild(headerRow);

        for (let row of data) {
          const tr = document.createElement("tr");

          const link = `${encodeURIComponent(row.id)}`;

          for (let key of displayFields) {
            const td = document.createElement("td");
            td.innerHTML = `<a href="javascript:void(0)" style="text-decoration:none; color:inherit;">${row[key] ?? ""}</a>`;
            td.querySelector('a').onclick = () => showQRCode(link);
            tr.appendChild(td);
          }

          tbody.appendChild(tr);
          document.getElementById('show_projact_name').textContent = row.projuct_title || "---";
        }

        document.getElementById('show_shift').textContent = data.length;
        table.style.display = "table";
        document.getElementById('status').style.display = 'none';
      })
      .catch(err => {
        document.getElementById('status').textContent = 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…5';
        console.error(err);
      });
  }
  // âœ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø¯Ø§Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
window.onload = loadData;
</script>
<script>   
  let role = sessionStorage.getItem("role");
                if (role === "admin") {
                   
                } else if(role === "supadmin") {
                  
                }else if(role === "emp") {
                   
                }else if (!role) {  // Ø§Ù„Ø´Ø±Ø· Ø§Ù„Ø°ÙŠ Ø£Ø¶ÙØªÙ‡ Ø£Ù†Øª
                    window.location.href = "/log_in";
                }  
</script>
{% endblock %}
</body>
</html>
