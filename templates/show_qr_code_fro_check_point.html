<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Check Point</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  * {
    box-sizing: border-box;
  }

  body {
    margin: 0;
    font-family: "Segoe UI", Tahoma, Arial, sans-serif;
    background: linear-gradient(135deg, #f4f6f8, #e9edf2);
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 20px;
  }

  center {
    width: 100%;
  }

  /* ğŸ§± Container */
  .container {
    width: 100%;
    max-width: 480px;
    background: #fff;
    border-radius: 14px;
    padding: 20px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
    text-align: center;
  }

  /* ğŸ“· QR Reader */
  #reader {
    width: 100%;
    max-width: 370px;
    height: 280px;
    margin: 0 auto 15px;
    border-radius: 12px;
    overflow: hidden;
    display: none;
    border: 2px dashed #4a90e2;
    aspect-ratio: 3 / 4; /* Ù…Ø«Ø§Ù„ÙŠ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */

  }

  #result {
    font-size: 14px;
    color: #555;
    margin-bottom: 10px;
  }

  /* ğŸ§¾ Table */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    font-size: 14px;
  }

  table tr:nth-child(even) {
    background: #f9fafb;
  }

  th, td {
    padding: 10px;
    border: 1px solid #e0e0e0;
    text-align: left;
  }

  td strong {
    color: #333;
  }

  /* âœï¸ Input */
  input[type="text"] {
    width: 100%;
    padding: 10px;
    border-radius: 10px;
    border: 1px solid #ccc;
    font-size: 14px;
    margin-top: 10px;
    outline: none;
  }

  input[type="text"]:focus {
    border-color: #4a90e2;
  }

  /* ğŸ”˜ Buttons */
  button {
    width: 100%;
    padding: 12px;
    font-size: 15px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    margin-top: 12px;
    transition: 0.3s ease;
  }

  button:hover {
    opacity: 0.9;
  }

  #startCameraBtn {
    background: #4a90e2;
    color: #fff;
  }

  #retryBtn {
    background: #f1f1f1;
    color: #333;
    display: none;
  }

  .confirm-btn {
    background: #2ecc71;
    color: #fff;
  }

  /* ğŸ“± Small screens */
  @media (max-width: 360px) {
    .container {
      padding: 15px;
    }

    table {
      font-size: 13px;
    }

    button {
      font-size: 14px;
    }
  }
</style>

</head>
<body>
<div class="container">

  <button id="startCameraBtn">ğŸ“· Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ ĞºĞ°Ğ¼ĞµÑ€Ñƒ</button>

  <div id="reader"></div>
  <div id="result"></div>

  <input type="text" id="check_point_id" placeholder="Check Point ID" hidden>

  <table>
    <tbody id="product-table"></tbody>
  </table>

  <button class="confirm-btn" onclick="checkLocation()">
    âœ”ï¸ ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¸ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğµ
  </button>

  <button id="retryBtn">ğŸ” ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ñ‚Ğµ</button>

</div>

<!-- ----------------------start qr reder-------------------------------------- -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script>
    const resultDiv = document.getElementById('result');
    const retryBtn = document.getElementById('retryBtn');

    let scanner;

    function startScanner() {
      document.body.style.backgroundColor = '#f4f4f4';
      resultDiv.textContent = '';
      retryBtn.style.display = 'none';

      scanner = new Html5Qrcode("reader");

      scanner.start(
        { facingMode: "environment" }, // Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ©
        {
          fps: 10,
          qrbox: 250
        },
        qrCodeMessage => {
          // Ù‚Ø±Ø§Ø¡Ø© Ù†Ø§Ø¬Ø­Ø©
          // ÙˆØ¶Ø¹ Ù‚ÙŠÙ…Ø© QR Ø¯Ø§Ø®Ù„ input
    document.getElementById("check_point_id").value = qrCodeMessage;

    if (/^\d+$/.test(qrCodeMessage)) {
        // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
                // Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·
        // âœ… ÙˆØ¶Ø¹ Ù‚ÙŠÙ…Ø© QR Ø¯Ø§Ø®Ù„ input
          document.getElementById("check_point_id").value = qrCodeMessage;
           
          fetchProducts();
          scanner.stop();
          retryBtn.style.display = 'inline-block';
          reader.style.display = 'none';

    } else if (/^[A-Za-z0-9 ]+$/) {
        // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©
        // Ø£Ø±Ù‚Ø§Ù… + Ø­Ø±ÙˆÙ Ùˆ Ù…Ø³Ø§ÙØ§Øª
         window.location.href =
        `/work_shift?title=${encodeURIComponent(qrCodeMessage)}`;

    } else {
        // Ø£ÙŠ Ù‚ÙŠÙ…Ø© Ø£Ø®Ø±Ù‰
        document.body.style.backgroundColor = 'red';
        alert("QR ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ");
    }
          
          
        },
        errorMessage => {
          // ÙŠÙ…ÙƒÙ† ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¨Ø³ÙŠØ·Ø©
        }
      ).catch(err => {
        resultDiv.textContent = "Ø­Ø¯Ø« Ø®Ø·Ø£: " + err;
      });
    }

   

    // Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³Ø­ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    //window.onload = startScanner;
  </script>
 <!-- ----------------------end qr reder-------------------------------------- -->
<script>
  
let lastData = [];

/* =========================
   Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ù‚Ø·Ø©
========================= */
function fetchProducts() {
  const checkPointId = document.getElementById("check_point_id").value.trim();
  const table = document.getElementById("product-table");
  table.innerHTML = "";
   
  lastData = [];

  if (!checkPointId) return;

  fetch(`/get_check_point?check_point_id=${encodeURIComponent(checkPointId)}`)
    .then(res => res.json())
    .then(data => {
      lastData = data;

      if (!data || data.length === 0) {
        table.innerHTML = "<tr><td>ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…</td></tr>";
         
        return;
      }

      const displayFields = {
        name_point: "Name Point"
      };

      data.forEach(row => {
        for (let key in displayFields) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><strong>${displayFields[key]}</strong></td>
            <td>${row[key] ?? ""}</td>
          `;
          table.appendChild(tr);
        }

        const sep = document.createElement("tr");
        sep.innerHTML = `<td colspan="2" style="background:#eee;height:8px;"></td>`;
        table.appendChild(sep);
      });

       
    })
    .catch(err => {
      console.error(err);
      alert("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…");
    });
}

/* =========================
   Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ + Ø§Ù„ØªØ³Ø¬ÙŠÙ„
========================= */
async function checkLocation() {
  const checkPointId = document.getElementById("check_point_id").value.trim();

  if (!checkPointId) {
    alert("âš ï¸ ĞÑ‚ÑĞºĞ°Ğ½Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ QR-ĞºĞ¾Ğ´ Ñ‚Ğ¾Ñ‡ĞºĞ¸");
    return;
  }

  if (!lastData || lastData.length === 0) {
    alert("âŒ ĞĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸");
    return;
  }

  if (!navigator.geolocation) {
    alert("âŒ Ğ“ĞµĞ¾Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ñ Ğ½Ğµ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ");
    return;
  }

  navigator.geolocation.getCurrentPosition(
    async position => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;

      let matched = false;

      lastData.forEach(row => {
        if (row.Coordinates) {
          const [dbLat, dbLng] = row.Coordinates.split(",").map(Number);
          const tolerance = 0.0005;

          if (
            Math.abs(lat - dbLat) < tolerance &&
            Math.abs(lng - dbLng) < tolerance
          ) {
            matched = true;
          }
        }
      });

      if (!matched) {
        alert("âš ï¸ Ğ’Ñ‹ Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ĞµÑÑŒ Ğ½Ğµ Ğ² Ğ½ÑƒĞ¶Ğ½Ğ¾Ğ¹ Ñ‚Ğ¾Ñ‡ĞºĞµ");
        return;
      }

      const formData = new FormData();
      formData.append("id_check_point", checkPointId);

      const response = await fetch(`/add_chickd_point_datatame`, {
        method: "POST",
        body: formData
      });

      const data = await response.json();
      console.log(data);

      alert("âœ… ĞŸÑ€Ğ¸ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ¶Ğ´ĞµĞ½Ğ¾");

      // ğŸ” Ø¥ÙØ±Ø§Øº Ø§Ù„ØµÙØ­Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø¬Ø§Ø­
      document.getElementById("check_point_id").value = "";
      document.getElementById("product-table").innerHTML = "";
      document.getElementById("result-count").textContent = "";
      lastData = [];
    },
    error => {
      alert("âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ³ĞµĞ¾Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ğ¸: " + error.message);
    }
  );
}
 retryBtn.addEventListener('click', () => {
    reader.style.display = 'inline-block';
      startScanner();
    });
</script>
<script>
  const startCameraBtn = document.getElementById("startCameraBtn");
  const readerDiv = document.getElementById("reader");

  startCameraBtn.addEventListener("click", () => {
    readerDiv.style.display = "block";
    startCameraBtn.style.display = "none";
    startScanner(); // Ù‡Ù†Ø§ ÙŠØªÙ… Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
  });
</script>

</body>
</html>
