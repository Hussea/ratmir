<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö —Å–º–µ–Ω—ã</title>
    {% extends "try.html" %}
  {% block page_css %}
  <style>
  /* ===== Global Theme (same as other pages) ===== */
:root {
  --primary: #0f172a;
  --secondary: #1e293b;
  --accent: #2563eb;
  --success: #16a34a;
  --danger: #dc2626;
  --bg: #f1f5f9;
  --card: #ffffff;
  --border: #e5e7eb;
}

/* ===== Base ===== */
body {
  background: var(--bg);
  font-family: "Segoe UI", Tahoma, Arial, sans-serif;
  color: #111;
}

/* ===== Header / Filters ===== */
#fers_info {
  max-width: 1200px;
  margin: 20px auto;
  padding: 18px 22px;
  background: var(--card);
  border-radius: 16px;
  border: 1px solid var(--border);
  box-shadow: 0 8px 22px rgba(0,0,0,0.06);
}

#fers_info h2 {
  margin-top: 0;
  color: var(--primary);
  font-size: 22px;
  font-weight: 600;
}

#fers_info label {
  font-weight: 600;
  margin-right: 10px;
}

#fers_info input[type="month"] {
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid var(--border);
  font-size: 14px;
}

#fers_info button {
  margin-left: 10px;
  padding: 9px 18px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 14px;
  cursor: pointer;
}

#fers_info button:hover {
  background: #1d4ed8;
}

/* ===== Status ===== */
#status {
  margin: 12px 0;
  padding: 10px 14px;
  border-radius: 10px;
  background: #fff7ed;
  color: #9a3412;
  font-weight: 600;
}

/* ===== Info Line ===== */
#info_line {
  margin-top: 14px;
  padding: 14px 18px;
  background: #f8fafc;
  border-radius: 12px;
  border: 1px solid var(--border);
  font-size: 14px;
  line-height: 1.8;
}

/* ===== Table ===== */
/* ===== ÿ¨ÿØŸàŸÑ ÿπÿßŸÖ ===== */
#data-table {
  width: 95%;
  margin: 20px auto;
  border-collapse: collapse;
  background: #fff;
}

#data-table th,
#data-table td {
  padding: 10px;
  border: 1px solid #ccc;
  text-align: center;
}

#data-table th {
  background: #f2f2f2;
  font-weight: bold;
}

/* ===== ÿµŸàÿ±ÿ© ÿØÿßÿÆŸÑ ÿßŸÑÿ¨ÿØŸàŸÑ ===== */
#data-table img {
  width: 80px;
  height: 80px;
  object-fit: cover;
  border-radius: 8px;
  cursor: pointer;
}

/* ================= MOBILE ================= */
@media (max-width: 768px) {

  #data-table,
  #data-table thead,
  #data-table tbody,
  #data-table th,
  #data-table td,
  #data-table tr {
    display: block;
    width: 100%;
  }

  #data-table thead {
    display: none; /* ÿ•ÿÆŸÅÿßÿ° ÿßŸÑŸáŸäÿØÿ± */
  }

  #data-table tr {
    margin-bottom: 15px;
    background: #f9f9f9;
    border-radius: 12px;
    padding: 10px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  #data-table td {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: none;
    border-bottom: 1px solid #ddd;
    padding: 8px 5px;
    font-size: 14px;
  }

  #data-table td:last-child {
    border-bottom: none;
  }

  /* ÿßŸÑÿπŸÜÿßŸàŸäŸÜ */
  #data-table td::before {
    content: attr(data-label);
    font-weight: bold;
    color: #555;
  }

  #data-table img {
    width: 70px;
    height: 70px;
  }
}

/* ===== Payment Form Panel ===== */
#divPiy {
  background: var(--card);
  border-radius: 18px;
  border: 1px solid var(--border);
  box-shadow: 0 12px 30px rgba(0,0,0,0.18);
}

#divPiy input,
#divPiy select,
#divPiy textarea {
  width: 100%;
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid var(--border);
  font-size: 14px;
}

#divPiy textarea {
  min-height: 120px;
  resize: vertical;
}

#divPiy input[type="submit"] {
  background: var(--success);
  color: white;
  border: none;
  border-radius: 12px;
  padding: 12px;
  font-size: 15px;
  cursor: pointer;
}

#divPiy input[type="submit"]:hover {
  background: #15803d;
}

/* ===== Last Payment Card ===== */
#info_line1 {
  background: #f1f5f9;
  border-radius: 12px;
  padding: 12px 14px;
  margin-bottom: 12px;
  font-size: 14px;
}

#goToSalaryHistoryBtn {
  margin-top: 10px;
  padding: 8px 14px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 10px;
  cursor: pointer;
}

#goToSalaryHistoryBtn:hover {
  background: #1d4ed8;
}

/* ===== Responsive ===== */
@media (max-width: 900px) {

  #fers_info {
    padding: 14px;
  }

  #data-table {
    display: block;
    overflow-x: auto;
    white-space: nowrap;
  }

  #divPiy {
    position: static;
    width: 100%;
    margin: 20px auto;
    height: auto;
  }
}

@media (max-width: 480px) {

  #fers_info h2 {
    font-size: 18px;
  }

  #fers_info button {
    margin-top: 10px;
    width: 100%;
  }

  #info_line {
    font-size: 13px;
  }
}
/* ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿµŸàÿ±ÿ© */
#imgModal {
  display: none;
  position: fixed;
  inset: 0;
  background-color: rgba(0, 0, 0, 0.9);
  z-index: 99999;

  display: flex;
  justify-content: center;
  align-items: center;
  padding: 20px;
}

/* ÿßŸÑÿµŸàÿ±ÿ© */
#imgModal img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  border-radius: 12px;
  box-shadow: 0 0 20px rgba(255,255,255,0.3);
  animation: zoomIn 0.3s ease;
}

/* ÿ≤ÿ± ÿßŸÑÿ•ÿ∫ŸÑÿßŸÇ */
.close-btn {
  position: absolute;
  top: 20px;
  right: 25px;
  font-size: 32px;
  color: white;
  cursor: pointer;
  background: rgba(0,0,0,0.6);
  border-radius: 50%;
  width: 45px;
  height: 45px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.close-btn:hover {
  background: red;
}

/* ÿ≠ÿ±ŸÉÿ© */
@keyframes zoomIn {
  from {
    transform: scale(0.85);
    opacity: 0;
  }
  to {
    transform: scale(1);
    opacity: 1;
  }
}

</style>
{% endblock %}

<body>
  {% block content %}
  
<div id="fers_info">
  <h2>–ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö —Å–º–µ–Ω—ã</h2>

    <label for="start_day"> –≤–≤–µ–¥–∏—Ç–µ –≥–æ–¥ –∏ –º–µ—Å—è—Ü:</label>
    <input type="month" id="start_day" />
  
    
    <button onclick="loadData()">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
    

<p id="status"> –£–∫–∞–∂–∏—Ç–µ –º–µ—Å—è—Ü –∏ –≥–æ–¥ ‚ö†Ô∏è</p>
<p id="info_line">
  <span><strong> –§–ò–û:</strong> <span id="show_employee_name"></span></span> |
  <br>
  <span><strong> –í –û–±–µ–∫—Ç:</strong> <span id="show_projact_name"></span></span> |
  <span><strong> –ó–ü :</strong> <span id="show_employee_sel"></span></span> |
  <span><strong> —Å–º–µ–Ω–∞:</strong> <span id="show_shift"></span></span> |
  <span><strong> —Å—É–º–∞ :</strong> <span id="show_sum"></span></span> 
</p>
</div>


<table id="data-table">
  <thead>
    <tr>
      <td>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</td>
      <td>–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞</td>
      <td>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</td>
      <td>–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è</td>
      <td>—Ñ–æ—Ç–æ</td>
    </tr>
  </thead>
  <tbody></tbody>
</table>
<script>
  // ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ≠ÿßŸÑŸä
  const today = new Date();
  // ÿ™ÿ≠ŸàŸäŸÑŸá ÿ•ŸÑŸâ ÿµŸäÿ∫ÿ© YYYY-MM
  const month = today.toISOString().slice(0, 7);
  // ÿ™ÿπŸäŸäŸÜŸá ŸÉŸÇŸäŸÖÿ© ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ŸÑŸÑŸÖÿØÿÆŸÑ
  document.getElementById("start_day").value = month;
</script>

<script>
  // ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑÿ®ÿßÿ±ÿßŸÖÿ™ÿ±ÿßÿ™ ŸÖŸÜ ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿµŸÅÿ≠ÿ©
  const params = new URLSearchParams(window.location.search);
  

  function loadData() {
    const empId = params.get("employee_id_input");
    const projId = params.get("project_id_input");
    const startDay = document.getElementById('start_day').value;
    document.getElementById("emp_id_send").value = params.get("employee_id_input");
    document.getElementById("proj_id_send").value = params.get("project_id_input");
    if (!empId || !projId || !startDay) {
      document.getElementById('status').textContent = '–£–∫–∞–∂–∏—Ç–µ –º–µ—Å—è—Ü –∏ –≥–æ–¥ ‚ùó';
      return;
    }

    let apiUrl = `/show_work_shift?employee_id_input=${empId}&project_id_input=${projId}`;
    if (startDay) {
      apiUrl += `&start_day=${startDay}-01`;
    }

    
    document.getElementById('status').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö üîÑ...';
    document.getElementById('data-table').style.display = 'none';
    document.querySelector('#data-table tbody').innerHTML = '';

    fetch(apiUrl)
      .then(res => res.json())
      .then(data => {
        if (!data || data.length === 0) {
          document.getElementById('status').textContent = ' –ù–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö ‚ùå';
          return;
        }

        const tbody = document.querySelector('#data-table tbody');
        let total = 0;

        data.forEach(item => {
          const row = document.createElement('tr');
          const selEmp = Number(item.projuct_sel_emp || 0);
          total += selEmp;

          row.innerHTML = `
  <td data-label="–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞">${item.start_day || "-"}</td>
  <td data-label="–í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞">${item.start_time || "-"}</td>
  <td data-label="–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è">${item.end_day || "-"}</td>
  <td data-label="–í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è">${item.end_time || "-"}</td>
  <td data-label="–§–æ—Ç–æ">
    <img src="${item.file_path}"
         alt="–Ω–µ—Ç —Ñ–æ—Ç–æ"
         onclick="showImage(this)">
  </td>
`;
          tbody.appendChild(row);
          document.getElementById('show_employee_name').textContent = `${item.employee_name}`;
          document.getElementById('show_projact_name').textContent = `${item.projuct_title}`;
          document.getElementById('show_employee_sel').textContent = `${item.projuct_sel_emp}`;
        });

        document.getElementById('data-table').style.display = 'table';
        document.getElementById('status').style.display = 'none';
        document.getElementById('show_shift').textContent = `${data.length}`;
        document.getElementById('show_sum').textContent = `${total}`;

      })
      .catch(err => {
        document.getElementById('status').textContent = '–ù–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö ‚ùå';
        console.error(err);
      });
      
  }
</script>
<!-- ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ™ŸÉÿ®Ÿäÿ± -->
<div id="imgModal" onclick="closeImage()">
  <img id="modalImg" src="">
</div>
<script>
function showImage(img) {
  const modal = document.getElementById("imgModal");
  const modalImg = document.getElementById("modalImg");

  modal.style.display = "flex";
  modalImg.src = img.src;
}

function closeImage() {
  document.getElementById("imgModal").style.display = "none";
}
closeImage();
</script>
<form id="employee-form" onsubmit="submitForm(event)" style="margin: 2%;">
<div id="form-message"></div>
   
  <input type="number" id="emp_id_send" name="emp_id_send" style="display: none;"/>
  <input type="number" id="proj_id_send" name="proj_id_send" style="display: none;"/>

<div id="divPiy" >
  
  <p id="info_line1">
  <strong>–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–ª–∞—Ç–µ–∂:</strong> 
  <span><strong> —Ç–∏–ø:</strong> <span id="show_employee_name_salry"></span></span> |
  <span><strong> –ó–∞:</strong> <span id="show_projact_name_salry"></span></span> |
  <span><strong> —Å—É–º–∞ :</strong> <span id="show_sum_salry"></span></span> 
  <button id="goToSalaryHistoryBtn">–ü–ª–∞—Ç–µ–∂–∏</button>
</p>
<input type="text" id="try" id="emp_ent" name="emp_ent" style="display: none;">
   

  <div class="form-row" style="margin: 2%;"> 
    <label for="sum_pay">—Å—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞:</label>
  <input type="number" id="sum_pay" name="sum_pay"  required/>
  </div>
  
<div class="form-row" style="margin: 2%;"> 
  <label for="pay_month" >–ó–∞ –º–µ—Å—è—Ü:</label>
  <input type="month" id="pay_month" name="pay_month" required/>

</div>
  <div class="form-row" style="margin: 2%;">
    <label for="mySelect">—Ç–∏–ø –∑–ø:</label>
  <select id="mySelect" required name="mySelect">
    <option value="" disabled selected hidden>–í—ã–±–∏—Ä–∞—Ç—å —Ç–∏–ø –∑–∞—Ä–ø–ª–∞—Ç–∞</option>
    <option value="–∑–∞—Ä–ø–ª–∞—Ç–∞">–∑–∞—Ä–ø–ª–∞—Ç–∞</option>
    <option value="–∞–≤–∞–Ω—Å">–∞–≤–∞–Ω—Å</option>
    <option value="–¥—Ä—É–≥–∏">–¥—Ä—É–≥–∏</option>
  </select>
  </div>
  
<div class="form-row" style="margin: 2%;">
<label for="pay_month" >notes:</label>
  <textarea id="notes" name="notes" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–≤–æ–∏ –∑–∞–º–µ—Ç–∫–∏ –∏–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –∑–¥–µ—Å—å..." ></textarea>

</div>
 
<center>
  <input type="submit" value="–æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å">
</center>
   
   </form>
</div>
 
<table id="data_table_salry">
  <tbody></tbody>
</table>
<script>
  // ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑÿ®ÿßÿ±ÿßŸÖÿ™ÿ±ÿßÿ™ ŸÖŸÜ ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿµŸÅÿ≠ÿ©
  
 function lost_salry() {
  const empId = params.get("employee_id_input");
  const projId = params.get("project_id_input");
   
  fetch(`/show_salary_history?employee_id_input=${empId}&project_id_input=${projId}`)
    .then(res => res.json())
    .then(data => {
      // ‚úÖ ŸÜÿ£ÿÆÿ∞ ŸÅŸÇÿ∑ ÿßŸÑÿ≥ÿ∑ÿ± ÿßŸÑÿ£ÿÆŸäÿ±
      const lastItem = data[data.length - 1];
      const tbody = document.querySelector('#data_table_salry tbody');
      const selEmp = Number(lastItem.sum || 0);
      const row = document.createElement('tr');
      tbody.appendChild(row);

      // ‚úÖ ÿ™ÿπÿ®ÿ¶ÿ© ÿ®ÿßŸÇŸä ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™
      document.getElementById('show_employee_name_salry').textContent = `${lastItem.pay_method}`;
      document.getElementById('show_projact_name_salry').textContent = `${lastItem.pay_for}`;
      document.getElementById('show_sum_salry').textContent = `${lastItem.sum}`;
    })
    .catch(err => {
      document.getElementById('status').textContent = '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö.';
      console.error(err);
    });
}

// ‚úÖ ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿØÿßŸÑÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
window.onload = function() {
    lost_salry();
    loadData();
};


</script>
 
<script>
 
  document.getElementById("goToSalaryHistoryBtn").addEventListener("click", function() {
      const employeeId = params.get("employee_id_input");
      const projectId = params.get("project_id_input");

      if (!employeeId || !projectId) {
          alert("Employee ID –∏–ª–∏ Project ID –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç!");
          return;
      }

      const url = `/show_salary_history_page?employee_id_input=${employeeId}&project_id_input=${projectId}`;
      window.location.href = url;
  });
</script>



<script>
   

    // ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸÜŸÖŸàÿ∞ÿ¨
    function submitForm(event) {
  event.preventDefault();

  const form = document.getElementById("employee-form");
  const formData = new FormData(form);

  fetch(`/salary_history`, {
    method: "POST",
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    const msg = document.getElementById("form-message");
    msg.textContent = data.message; // üëà ŸÜÿπÿ±ÿ∂ ŸÜŸÅÿ≥ ÿßŸÑŸÜÿµ ÿßŸÑŸÇÿßÿØŸÖ ŸÖŸÜ ÿ®ÿßŸäÿ´ŸàŸÜ

    if (data.status === "success") {
      document.getElementById('employee-form').reset();
      msg.style.color = "green";
    } else {
      msg.style.color = "red";
    }

    console.log("Server response:", data);
  })
  .catch(error => {
    const msg = document.getElementById("form-message");
    msg.style.color = "red";
    msg.textContent = "‚ö†Ô∏è ŸÅÿ¥ŸÑ ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑÿÆÿßÿØŸÖ";
    console.error("Fetch error:", error);
  });
}


  </script>
  



</body>

</html>
<script>
  
  let role = sessionStorage.getItem("role");
  let user = sessionStorage.getItem("username");
  document.getElementById("try").value = role +" "+ user;
                if (role === "admin") {
                   
                } else if(role === "supadmin") {
                  document.getElementById("employee-form").style.display = "none";
                }else if(role === "emp") {
                    
                }else if (!role) {  // ÿßŸÑÿ¥ÿ±ÿ∑ ÿßŸÑÿ∞Ÿä ÿ£ÿ∂ŸÅÿ™Ÿá ÿ£ŸÜÿ™
                    window.location.href = "/log_in";
                }
</script>
{% endblock %}